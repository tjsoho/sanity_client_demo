'use strict';

Object.defineProperty(exports, '__esModule', { value: true });

var uuid = require('@sanity/uuid');
var constants = require('./constants.cjs');
var generateSecret = require('./_chunks-cjs/generateSecret.cjs');

async function createPreviewSecret(_client, source, studioUrl, userId, id = uuid.uuid()) {
  const client = _client.withConfig({ apiVersion: constants.apiVersion });
  try {
    const expiresAt = new Date(Date.now() + 1e3 * constants.SECRET_TTL);
    const _id = `drafts.${id}`;
    const newSecret = generateSecret.generateUrlSecret();
    const patch = client.patch(_id).set({ secret: newSecret, source, studioUrl, userId });
    await client.transaction().createOrReplace({ _id, _type: constants.schemaType }).patch(patch).commit({ tag: constants.tag });
    return { secret: newSecret, expiresAt };
  } finally {
    try {
      await client.delete({ query: constants.deleteExpiredSecretsQuery });
    } catch (err) {
      console.error("Failed to delete expired secrets", err);
    }
  }
}

exports.createPreviewSecret = createPreviewSecret;
//# sourceMappingURL=create-secret.cjs.map
