import { memo, useMemo, useEffect } from "react";
import { Subject, switchMap, combineLatest, share, skipWhile, NEVER, merge, takeUntil, debounceTime } from "rxjs";
import { useDocumentPreviewStore, useSchema, getDraftId, getPublishedId } from "sanity";
const PostMessagePreviews = (props) => {
  const { comlink, refs, perspective } = props, documentPreviewStore = useDocumentPreviewStore(), schema = useSchema(), refsSubject = useMemo(() => new Subject(), []), previews$ = useMemo(() => refsSubject.asObservable().pipe(
    switchMap((refs2) => combineLatest(
      refs2.map((ref) => {
        const draftRef = { ...ref, _id: getDraftId(ref._id) }, draft$ = perspective === "previewDrafts" ? documentPreviewStore.observeForPreview(draftRef, schema.get(draftRef._type)).pipe(
          // Share to prevent double subscribe in the merge
          share(),
          // Don't emit if no snapshot is returned
          skipWhile((p) => p.snapshot === null)
        ) : (
          // Don't emit if not displaying drafts
          NEVER
        ), publishedRef = { ...ref, _id: getPublishedId(ref._id) }, published$ = documentPreviewStore.observeForPreview(
          publishedRef,
          schema.get(publishedRef._type)
        );
        return merge(published$.pipe(takeUntil(draft$)), draft$);
      })
    )),
    debounceTime(0)
  ), [documentPreviewStore, refsSubject, schema, perspective]);
  return useEffect(() => {
    const sub = previews$.subscribe((snapshots) => {
      comlink.post({
        type: "presentation/preview-snapshots",
        data: {
          snapshots: snapshots.filter((s) => s.snapshot).map((s) => {
            const snapshot = s.snapshot;
            return { ...snapshot, _id: getPublishedId(snapshot._id) };
          })
        }
      });
    });
    return () => {
      sub.unsubscribe();
    };
  }, [comlink, previews$]), useEffect(() => {
    refsSubject.next(refs);
  }, [refs, refsSubject]), null;
};
var PostMessagePreviewSnapshots = memo(PostMessagePreviews);
export {
  PostMessagePreviewSnapshots as default
};
//# sourceMappingURL=PostMessagePreviewSnapshots.js.map
