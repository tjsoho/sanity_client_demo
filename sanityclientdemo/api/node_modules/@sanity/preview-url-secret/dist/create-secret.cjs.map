{"version":3,"file":"create-secret.cjs","sources":["../src/createPreviewSecret.ts"],"sourcesContent":["import type {SanityClient} from '@sanity/client'\nimport {uuid} from '@sanity/uuid'\nimport {apiVersion, deleteExpiredSecretsQuery, schemaType, SECRET_TTL, tag} from './constants'\nimport {generateUrlSecret} from './generateSecret'\nimport type {SanityClientLike} from './types'\n\n/** @internal */\nexport async function createPreviewSecret(\n  _client: SanityClient,\n  source: string,\n  studioUrl: string,\n  userId?: string,\n  id = uuid(),\n): Promise<{secret: string; expiresAt: Date}> {\n  const client = _client.withConfig({apiVersion})\n\n  try {\n    const expiresAt = new Date(Date.now() + 1000 * SECRET_TTL)\n    const _id = `drafts.${id}`\n    const newSecret = generateUrlSecret()\n    const patch = client.patch(_id).set({secret: newSecret, source, studioUrl, userId})\n    await client.transaction().createOrReplace({_id, _type: schemaType}).patch(patch).commit({tag})\n\n    return {secret: newSecret, expiresAt}\n  } finally {\n    try {\n      // Garbage collect expired secrets\n      await client.delete({query: deleteExpiredSecretsQuery})\n    } catch (err) {\n      // eslint-disable-next-line no-console\n      console.error('Failed to delete expired secrets', err)\n    }\n  }\n}\n\nexport type {SanityClientLike}\n"],"names":["uuid","apiVersion","SECRET_TTL","generateUrlSecret","schemaType","tag","deleteExpiredSecretsQuery"],"mappings":";;;;;;;;AAOA,eAAsB,oBACpB,OACA,EAAA,MAAA,EACA,WACA,MACA,EAAA,EAAA,GAAKA,WACuC,EAAA;AAC5C,EAAA,MAAM,MAAS,GAAA,OAAA,CAAQ,UAAW,CAAA,cAACC,sBAAW,CAAA,CAAA;AAE9C,EAAI,IAAA;AACF,IAAA,MAAM,YAAY,IAAI,IAAA,CAAK,KAAK,GAAI,EAAA,GAAI,MAAOC,oBAAU,CAAA,CAAA;AACzD,IAAM,MAAA,GAAA,GAAM,UAAU,EAAE,CAAA,CAAA,CAAA;AACxB,IAAA,MAAM,YAAYC,gCAAkB,EAAA,CAAA;AACpC,IAAA,MAAM,KAAQ,GAAA,MAAA,CAAO,KAAM,CAAA,GAAG,CAAE,CAAA,GAAA,CAAI,EAAC,MAAA,EAAQ,SAAW,EAAA,MAAA,EAAQ,SAAW,EAAA,MAAA,EAAO,CAAA,CAAA;AAClF,IAAA,MAAM,OAAO,WAAY,EAAA,CAAE,eAAgB,CAAA,EAAC,KAAK,KAAO,EAAAC,oBAAA,EAAW,CAAA,CAAE,MAAM,KAAK,CAAA,CAAE,MAAO,CAAA,OAACC,eAAI,CAAA,CAAA;AAE9F,IAAO,OAAA,EAAC,MAAQ,EAAA,SAAA,EAAW,SAAS,EAAA,CAAA;AAAA,GACpC,SAAA;AACA,IAAI,IAAA;AAEF,MAAA,MAAM,MAAO,CAAA,MAAA,CAAO,EAAC,KAAA,EAAOC,qCAA0B,CAAA,CAAA;AAAA,aAC/C,GAAK,EAAA;AAEZ,MAAQ,OAAA,CAAA,KAAA,CAAM,oCAAoC,GAAG,CAAA,CAAA;AAAA,KACvD;AAAA,GACF;AACF;;;;"}