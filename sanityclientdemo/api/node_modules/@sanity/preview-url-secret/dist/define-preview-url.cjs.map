{"version":3,"file":"define-preview-url.cjs","sources":["../src/definePreviewUrl.ts"],"sourcesContent":["import {\n  urlSearchParamPreviewPathname,\n  urlSearchParamPreviewPerspective,\n  urlSearchParamPreviewSecret,\n} from './constants'\nimport type {\n  PreviewUrlResolver,\n  PreviewUrlResolverContext,\n  PreviewUrlResolverOptions,\n} from './types'\n\n/**\n * @internal\n */\nexport function definePreviewUrl<SanityClientType>(\n  options: PreviewUrlResolverOptions,\n): PreviewUrlResolver<SanityClientType> {\n  const {\n    draftMode,\n    previewMode,\n    origin = typeof location === 'undefined' ? 'https://localhost' : location.origin,\n  } = options\n  const enableUrl = previewMode?.enable || draftMode?.enable\n  let {preview = '/'} = options\n  const productionUrl = new URL(preview, origin)\n  const enablePreviewModeUrl = enableUrl ? new URL(enableUrl, origin) : undefined\n\n  return async (context): Promise<string> => {\n    try {\n      if (context.previewSearchParam) {\n        const restoredUrl = new URL(context.previewSearchParam, productionUrl)\n        if (restoredUrl.origin === productionUrl.origin) {\n          preview = `${restoredUrl.pathname}${restoredUrl.search}`\n        }\n      }\n    } catch {\n      // ignore\n    }\n    // Prevent infinite recursion\n    if (\n      typeof location !== 'undefined' &&\n      location.origin === productionUrl.origin &&\n      context.studioBasePath &&\n      (preview.startsWith(`${context.studioBasePath}/`) || preview === context.studioBasePath)\n    ) {\n      preview = options.preview || '/'\n    }\n    const previewUrl = new URL(preview, productionUrl)\n    if (enablePreviewModeUrl) {\n      const enablePreviewModeRequestUrl = new URL(enablePreviewModeUrl)\n      const {searchParams} = enablePreviewModeRequestUrl\n      searchParams.set(urlSearchParamPreviewSecret, context.previewUrlSecret)\n      searchParams.set(urlSearchParamPreviewPerspective, context.studioPreviewPerspective)\n      if (previewUrl.pathname !== enablePreviewModeRequestUrl.pathname) {\n        searchParams.set(\n          urlSearchParamPreviewPathname,\n          `${previewUrl.pathname}${previewUrl.search}`,\n        )\n      }\n\n      return enablePreviewModeRequestUrl.toString()\n    }\n    return previewUrl.toString()\n  }\n}\n\nexport type {PreviewUrlResolver, PreviewUrlResolverContext, PreviewUrlResolverOptions}\n"],"names":["urlSearchParamPreviewSecret","urlSearchParamPreviewPerspective","urlSearchParamPreviewPathname"],"mappings":";;;;;;AAcO,SAAS,iBACd,OACsC,EAAA;AACtC,EAAM,MAAA;AAAA,IACJ,SAAA;AAAA,IACA,WAAA;AAAA,IACA,MAAS,GAAA,OAAO,QAAa,KAAA,WAAA,GAAc,sBAAsB,QAAS,CAAA,MAAA;AAAA,GACxE,GAAA,OAAA,CAAA;AACJ,EAAM,MAAA,SAAA,GAAY,WAAa,EAAA,MAAA,IAAU,SAAW,EAAA,MAAA,CAAA;AACpD,EAAI,IAAA,EAAC,OAAU,GAAA,GAAA,EAAO,GAAA,OAAA,CAAA;AACtB,EAAA,MAAM,aAAgB,GAAA,IAAI,GAAI,CAAA,OAAA,EAAS,MAAM,CAAA,CAAA;AAC7C,EAAA,MAAM,uBAAuB,SAAY,GAAA,IAAI,GAAI,CAAA,SAAA,EAAW,MAAM,CAAI,GAAA,KAAA,CAAA,CAAA;AAEtE,EAAA,OAAO,OAAO,OAA6B,KAAA;AACzC,IAAI,IAAA;AACF,MAAA,IAAI,QAAQ,kBAAoB,EAAA;AAC9B,QAAA,MAAM,WAAc,GAAA,IAAI,GAAI,CAAA,OAAA,CAAQ,oBAAoB,aAAa,CAAA,CAAA;AACrE,QAAI,IAAA,WAAA,CAAY,MAAW,KAAA,aAAA,CAAc,MAAQ,EAAA;AAC/C,UAAA,OAAA,GAAU,CAAG,EAAA,WAAA,CAAY,QAAQ,CAAA,EAAG,YAAY,MAAM,CAAA,CAAA,CAAA;AAAA,SACxD;AAAA,OACF;AAAA,KACM,CAAA,MAAA;AAAA,KAER;AAEA,IAAA,IACE,OAAO,QAAa,KAAA,WAAA,IACpB,SAAS,MAAW,KAAA,aAAA,CAAc,UAClC,OAAQ,CAAA,cAAA,KACP,OAAQ,CAAA,UAAA,CAAW,GAAG,OAAQ,CAAA,cAAc,GAAG,CAAK,IAAA,OAAA,KAAY,QAAQ,cACzE,CAAA,EAAA;AACA,MAAA,OAAA,GAAU,QAAQ,OAAW,IAAA,GAAA,CAAA;AAAA,KAC/B;AACA,IAAA,MAAM,UAAa,GAAA,IAAI,GAAI,CAAA,OAAA,EAAS,aAAa,CAAA,CAAA;AACjD,IAAA,IAAI,oBAAsB,EAAA;AACxB,MAAM,MAAA,2BAAA,GAA8B,IAAI,GAAA,CAAI,oBAAoB,CAAA,CAAA;AAChE,MAAM,MAAA,EAAC,cAAgB,GAAA,2BAAA,CAAA;AACvB,MAAa,YAAA,CAAA,GAAA,CAAIA,qCAA6B,EAAA,OAAA,CAAQ,gBAAgB,CAAA,CAAA;AACtE,MAAa,YAAA,CAAA,GAAA,CAAIC,0CAAkC,EAAA,OAAA,CAAQ,wBAAwB,CAAA,CAAA;AACnF,MAAI,IAAA,UAAA,CAAW,QAAa,KAAA,2BAAA,CAA4B,QAAU,EAAA;AAChE,QAAa,YAAA,CAAA,GAAA;AAAA,UACXC,uCAAA;AAAA,UACA,CAAG,EAAA,UAAA,CAAW,QAAQ,CAAA,EAAG,WAAW,MAAM,CAAA,CAAA;AAAA,SAC5C,CAAA;AAAA,OACF;AAEA,MAAA,OAAO,4BAA4B,QAAS,EAAA,CAAA;AAAA,KAC9C;AACA,IAAA,OAAO,WAAW,QAAS,EAAA,CAAA;AAAA,GAC7B,CAAA;AACF;;;;"}