{"version":3,"file":"PostMessageDocuments.js","sources":["../../src/overlays/PostMessageDocuments.tsx"],"sourcesContent":["import type {MutationEvent, ReconnectEvent, WelcomeEvent} from '@sanity/client'\nimport {memo, useEffect, type FunctionComponent} from 'react'\nimport {filter, first, merge, shareReplay} from 'rxjs'\nimport {useClient} from 'sanity'\nimport {API_VERSION} from '../constants'\nimport type {VisualEditingConnection} from '../types'\n\ninterface PostMessageDocumentsProps {\n  comlink: VisualEditingConnection\n}\n\nconst PostMessageDocuments: FunctionComponent<PostMessageDocumentsProps> = (props) => {\n  const {comlink} = props\n  const client = useClient({apiVersion: API_VERSION})\n\n  useEffect(() => {\n    const listener = client\n      .listen(\n        '*[!(_id in path(\"_.**\"))]',\n        {},\n        {\n          effectFormat: 'mendoza',\n          events: ['welcome', 'mutation', 'reconnect'],\n          includePreviousRevision: false,\n          includeResult: false,\n          tag: 'presentation-documents',\n          visibility: 'transaction',\n        },\n      )\n      .pipe(\n        filter(\n          (event): event is WelcomeEvent | ReconnectEvent | MutationEvent =>\n            event.type === 'welcome' || event.type === 'reconnect' || event.type === 'mutation',\n        ),\n      )\n\n    const welcome = listener.pipe(\n      filter((event): event is WelcomeEvent => event.type === 'welcome'),\n      shareReplay({bufferSize: 1, refCount: false}),\n    )\n\n    // When new contexts initialize, they need to explicitly request the welcome\n    // event, as we can't rely on emitting it into the void\n    const unsubscribe = comlink.on('visual-editing/snapshot-welcome', async () => {\n      const event = await new Promise<WelcomeEvent>((resolve) => {\n        welcome.pipe(first()).subscribe((event) => {\n          resolve(event)\n        })\n      })\n      return {event}\n    })\n\n    const reconnect = listener.pipe(\n      filter((event): event is ReconnectEvent => event.type === 'reconnect'),\n    )\n\n    const mutations = listener.pipe(\n      filter((event): event is MutationEvent => event.type === 'mutation'),\n    )\n\n    const events = merge(\n      /**\n       * @deprecated remove 'welcome' here and switch to explict welcome message fetching at next major\n       */\n      welcome,\n      mutations,\n      reconnect,\n    ).subscribe((event) => {\n      comlink.post({type: 'presentation/snapshot-event', data: {event}})\n    })\n\n    return () => {\n      unsubscribe()\n      events.unsubscribe()\n    }\n  }, [client, comlink])\n\n  useEffect(() => {\n    return comlink.on('visual-editing/fetch-snapshot', async (data) => {\n      const snapshot = await client.getDocument(data.documentId, {\n        tag: 'document.snapshots',\n      })\n      return {snapshot}\n    })\n  }, [client, comlink])\n\n  useEffect(() => {\n    return comlink.on('visual-editing/mutate', async (data) => {\n      return client.dataRequest('mutate', data, {\n        visibility: 'async',\n        returnDocuments: true,\n      })\n    })\n  }, [client, comlink])\n\n  return null\n}\n\nexport default memo(PostMessageDocuments)\n"],"names":["event"],"mappings":";;;;AAWA,MAAM,uBAAqE,CAAC,UAAU;AAC9E,QAAA,EAAC,QAAW,IAAA,OACZ,SAAS,UAAU,EAAC,YAAY,YAAA,CAAY;AAElD,SAAA,UAAU,MAAM;AACd,UAAM,WAAW,OACd;AAAA,MACC;AAAA,MACA,CAAC;AAAA,MACD;AAAA,QACE,cAAc;AAAA,QACd,QAAQ,CAAC,WAAW,YAAY,WAAW;AAAA,QAC3C,yBAAyB;AAAA,QACzB,eAAe;AAAA,QACf,KAAK;AAAA,QACL,YAAY;AAAA,MACd;AAAA,IAAA,EAED;AAAA,MACC;AAAA,QACE,CAAC,UACC,MAAM,SAAS,aAAa,MAAM,SAAS,eAAe,MAAM,SAAS;AAAA,MAC7E;AAAA,IAAA,GAGE,UAAU,SAAS;AAAA,MACvB,OAAO,CAAC,UAAiC,MAAM,SAAS,SAAS;AAAA,MACjE,YAAY,EAAC,YAAY,GAAG,UAAU,IAAM;AAAA,IAAA,GAKxC,cAAc,QAAQ,GAAG,mCAAmC,aAMzD,EAAC,OALM,MAAM,IAAI,QAAsB,CAAC,YAAY;AACzD,cAAQ,KAAK,MAAM,CAAC,EAAE,UAAU,CAACA,WAAU;AACzC,gBAAQA,MAAK;AAAA,MAAA,CACd;AAAA,IACF,CAAA,IAEF,GAEK,YAAY,SAAS;AAAA,MACzB,OAAO,CAAC,UAAmC,MAAM,SAAS,WAAW;AAAA,IAAA,GAGjE,YAAY,SAAS;AAAA,MACzB,OAAO,CAAC,UAAkC,MAAM,SAAS,UAAU;AAAA,OAG/D,SAAS;AAAA;AAAA;AAAA;AAAA,MAIb;AAAA,MACA;AAAA,MACA;AAAA,IAAA,EACA,UAAU,CAAC,UAAU;AACb,cAAA,KAAK,EAAC,MAAM,+BAA+B,MAAM,EAAC,SAAO;AAAA,IAAA,CAClE;AAED,WAAO,MAAM;AACC,kBAAA,GACZ,OAAO;IAAY;AAAA,EACrB,GACC,CAAC,QAAQ,OAAO,CAAC,GAEpB,UAAU,MACD,QAAQ,GAAG,iCAAiC,OAAO,UAIjD,EAAC,UAHS,MAAM,OAAO,YAAY,KAAK,YAAY;AAAA,IACzD,KAAK;AAAA,EAAA,CACN,EACe,EACjB,GACA,CAAC,QAAQ,OAAO,CAAC,GAEpB,UAAU,MACD,QAAQ,GAAG,yBAAyB,OAAO,SACzC,OAAO,YAAY,UAAU,MAAM;AAAA,IACxC,YAAY;AAAA,IACZ,iBAAiB;AAAA,EAClB,CAAA,CACF,GACA,CAAC,QAAQ,OAAO,CAAC,GAEb;AACT;AAEA,IAAe,yBAAA,KAAK,oBAAoB;"}